import{d as A,w as S}from"./index.e20c554c.js";const b=!0,P=b;class ${constructor(){this.db=null,this.isReady=!1,this.init()}async init(){return new Promise((e,t)=>{const s=indexedDB.open("MorningQuizDB",3);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,this.isReady=!0,e(this.db)},s.onupgradeneeded=r=>{const o=r.target.result;["users","quizzes","questions","results","lessons","notifications","sync_queue"].forEach(a=>{if(!o.objectStoreNames.contains(a)){const f=o.createObjectStore(a,{keyPath:"id",autoIncrement:!0});f.createIndex("timestamp","timestamp"),a==="sync_queue"&&(f.createIndex("status","status"),f.createIndex("type","type"))}})}})}async store(e,t){return this.isReady||await this.init(),this.db.transaction([e],"readwrite").objectStore(e).put({...t,timestamp:Date.now()})}async get(e,t){return this.isReady||await this.init(),this.db.transaction([e],"readonly").objectStore(e).get(t)}async getAll(e){return this.isReady||await this.init(),this.db.transaction([e],"readonly").objectStore(e).getAll()}async delete(e,t){return this.isReady||await this.init(),this.db.transaction([e],"readwrite").objectStore(e).delete(t)}async clear(e){return this.isReady||await this.init(),this.db.transaction([e],"readwrite").objectStore(e).clear()}async addToSyncQueue(e,t,s="api"){return this.store("sync_queue",{action:e,data:t,type:s,status:"pending",retries:0,timestamp:Date.now()})}async getSyncQueue(){return this.getAll("sync_queue")}async updateSyncItem(e,t){this.isReady||await this.init();const r=this.db.transaction(["sync_queue"],"readwrite").objectStore("sync_queue"),o=await r.get(e);if(o)return r.put({...o,...t})}}const i=new $;function I(){const{subscribe:u,set:e}=S(navigator.onLine);return window.addEventListener("online",()=>e(!0)),window.addEventListener("offline",()=>e(!1)),{subscribe:u}}function z(){const{subscribe:u,set:e,update:t}=S({isSyncing:!1,lastSync:null,pendingItems:0,errors:[]});return{subscribe:u,startSync:()=>t(s=>({...s,isSyncing:!0})),endSync:(s=!0,r=null)=>t(o=>({...o,isSyncing:!1,lastSync:s?Date.now():o.lastSync,errors:r?[...o.errors,r]:o.errors})),setPendingItems:s=>t(r=>({...r,pendingItems:s})),clearErrors:()=>t(s=>({...s,errors:[]}))}}function O(){const{subscribe:u,set:e,update:t}=S(null);return{subscribe:u,login:async s=>{e(s),localStorage.setItem("user",JSON.stringify(s)),await i.store("users",{...s,current:!0})},logout:async()=>{e(null),localStorage.removeItem("token"),localStorage.removeItem("user"),await i.clear("users"),window.location.href="/"},init:async()=>{if(localStorage.getItem("token")){const r=localStorage.getItem("user");if(r){const o=JSON.parse(r);e(o),await i.store("users",{...o,current:!0})}}}}}function B(){const{subscribe:u,set:e,update:t}=S({quizzes:[],questions:[],results:[],lessons:[],notifications:[]});return{subscribe:u,loadFromCache:async()=>{const[s,r,o,n,a]=await Promise.all([i.getAll("quizzes"),i.getAll("questions"),i.getAll("results"),i.getAll("lessons"),i.getAll("notifications")]);e({quizzes:s,questions:r,results:o,lessons:n,notifications:a})},updateQuizzes:async s=>{t(r=>({...r,quizzes:s}));{await i.clear("quizzes");for(const r of s)await i.store("quizzes",r)}},updateQuestions:async s=>{t(r=>({...r,questions:s}));{await i.clear("questions");for(const r of s)await i.store("questions",r)}},updateResults:async s=>{t(r=>({...r,results:s}));{await i.clear("results");for(const r of s)await i.store("results",r)}},updateLessons:async s=>{t(r=>({...r,lessons:s}));{await i.clear("lessons");for(const r of s)await i.store("lessons",r)}},updateNotifications:async s=>{t(r=>({...r,notifications:s}));{await i.clear("notifications");for(const r of s)await i.store("notifications",r)}},addToSyncQueue:async(s,r)=>{await i.addToSyncQueue(s,r),g.setPendingItems((await i.getSyncQueue()).length)}}}class D{constructor(){this.isOnline=navigator.onLine,this.syncInProgress=!1,window.addEventListener("online",()=>{this.isOnline=!0,this.performSync()}),window.addEventListener("offline",()=>{this.isOnline=!1})}async performSync(){if(!(!this.isOnline||this.syncInProgress)){this.syncInProgress=!0,g.startSync();try{const t=(await i.getSyncQueue()).filter(s=>s.status==="pending");for(const s of t)try{await this.processSyncItem(s),await i.delete("sync_queue",s.id)}catch(r){await i.updateSyncItem(s.id,{status:"error",retries:(s.retries||0)+1,lastError:r.message})}g.endSync(!0)}catch(e){g.endSync(!1,e.message)}finally{this.syncInProgress=!1;const e=await i.getSyncQueue();g.setPendingItems(e.length)}}}async processSyncItem(e){console.log("Syncing item:",e),await new Promise(t=>setTimeout(t,1e3))}async forcSync(){this.isOnline&&await this.performSync()}}const L=new D,x=O(),E=I(),g=z(),k=B();A(E,u=>!u);const _=A([E,g],([u,e])=>u&&!e.isSyncing&&e.pendingItems>0);k.loadFromCache(),x.init();function l(){const u=window.location.hostname;if(console.log("[API] Detecting hostname:",u),u.includes("pages.dev")||u.includes("tsskwizi"))return console.log("[API] Using Render backend for Cloudflare Pages"),"https://tvet-quiz-backend.onrender.com";const e=u==="localhost"||u==="127.0.0.1"?"http://localhost:8000":`http://${u}:8000`;return console.log("[API] Using local backend:",e),e}class v{constructor(){this._token=null,this.isInitialized=!1,this.connectionTested=!1,this.isOffline=!1,this.offlineData=new Map,this.initToken(),this.initOfflineHandling()}initOfflineHandling(){{const e=localStorage.getItem("offlineData");if(e)try{const t=JSON.parse(e);Object.entries(t).forEach(([s,r])=>{this.offlineData.set(s,r)})}catch{}window.addEventListener("online",()=>{this.isOffline=!1,this.syncOfflineData()}),window.addEventListener("offline",()=>{this.isOffline=!0}),this.isOffline=!navigator.onLine}}cacheData(e,t){this.offlineData.set(e,{data:t,timestamp:Date.now()});{const s=Object.fromEntries(this.offlineData);localStorage.setItem("offlineData",JSON.stringify(s))}}getCachedData(e,t=3e5){const s=this.offlineData.get(e);return s&&Date.now()-s.timestamp<t?s.data:null}async getOfflineData(e){try{const s={"/quizzes":"quizzes","/questions":"questions","/results":"results","/lessons":"lessons","/notifications":"notifications"}[e];if(s){const r=await i.getAll(s);return r.length>0?r:null}}catch(t){console.error("Error getting offline data:",t)}return null}async storeOfflineData(e,t){try{e==="/quizzes"?await k.updateQuizzes(Array.isArray(t)?t:[t]):e==="/questions"?await k.updateQuestions(Array.isArray(t)?t:[t]):e.includes("/results")?await k.updateResults(Array.isArray(t)?t:[t]):e==="/lessons"?await k.updateLessons(Array.isArray(t)?t:[t]):e==="/notifications"&&await k.updateNotifications(Array.isArray(t)?t:[t])}catch(s){console.error("Error storing offline data:",s)}}async queueOfflineAction(e,t){try{await i.addToSyncQueue(e,{method:t.method,body:t.body,headers:t.headers});const s=(await i.getSyncQueue()).length;g.setPendingItems(s)}catch(s){console.error("Error queuing offline action:",s)}}async syncOfflineData(){if(!this.isOffline)try{g.startSync();const t=(await i.getSyncQueue()).filter(s=>s.status==="pending");for(const s of t)try{const r=await this.request(s.action,{method:s.data.method,body:s.data.body,headers:s.data.headers});await i.delete("sync_queue",s.id)}catch(r){await i.updateSyncItem(s.id,{status:"error",retries:(s.retries||0)+1,lastError:r.message})}g.endSync(!0)}catch(e){g.endSync(!1,e.message)}}initToken(){this._token=localStorage.getItem("token"),this.isInitialized=!0}setToken(e){this._token=e,this.connectionTested=!1,localStorage.setItem("token",e)}clearToken(){this._token=null,this.connectionTested=!1,this.isInitialized=!1,localStorage.removeItem("token"),localStorage.removeItem("user")}forceReinit(){this.clearToken(),this.initToken(),this.connectionTested=!1}async request(e,t={}){this.isInitialized||this.initToken();const s=t.method||"GET",r=`${s}:${e}`;e!=="/auth/test"&&console.log(`[API] ${s} request to ${e}`);const n=["/auth/login","/auth/register","/auth/test","/health","/lessons","/admin/","/teacher-lessons","/announcements","/schedules","/broadcast","/quizzes","/questions","/submit"].some(c=>e.includes(c))||e==="/lessons"||s==="POST"&&e.startsWith("/lessons")||e.includes("/broadcast")||e.includes("/questions")||e.includes("/submit");if(["POST","PUT","DELETE"].includes(s)&&!n)return console.log(`[API] Queueing ${s} request to ${e}`),await this.queueOfflineAction(e,t),{queued:!0,message:"Action saved locally",offline:!0,timestamp:Date.now()};let f=`${l()}${e}`;console.log(`[API] Request URL: ${f}`);const d={headers:{"Content-Type":"application/json",...t.headers},...t};if(!this._token){const c=localStorage.getItem("token");c&&(this._token=c)}if(this._token&&(d.headers.Authorization=`Bearer ${this._token}`),d.body&&typeof d.body=="object"&&(d.body=JSON.stringify(d.body)),e==="/auth/test"){if(!this._token)throw new Error("No authentication token");const c=this.getCachedData(r,3e4);if(c)return c}try{const c=new AbortController,m=P&&(window.location.hostname.includes("pages.dev")||window.location.hostname.includes("tsskwizi"))?6e4:3e3,T=setTimeout(()=>c.abort(),m);d.signal=c.signal;const h=await fetch(f,d);if(clearTimeout(T),!h.ok){if(h.status===401||h.status===403)throw e!=="/auth/test"&&this.clearToken(),new Error("Authentication failed");if(h.status===400)try{const w=await h.json();throw new Error(w.detail||`HTTP ${h.status}`)}catch(w){throw w.message.includes("HTTP")?w:new Error(`HTTP ${h.status}`)}throw new Error(`HTTP ${h.status}`)}this.connectionTested=!0;const p=await h.json();return(!t.method||t.method==="GET")&&(this.cacheData(r,p),e!=="/auth/test"&&await this.storeOfflineData(e,p)),p}catch(c){if(c.name==="AbortError"?console.error(`[API] Request timeout for ${e}`):e!=="/auth/test"&&console.error(`[API] Network error for ${e}:`,c.message),s==="GET"){const y=this.getCachedData(r);if(y)return e!=="/auth/test"&&console.log(`[API] Using cached fallback for ${e}`),y}throw new Error(c.message||"Local server not available")}}async login(e,t){var o,n;console.log("üîê API: Starting login for user:",e),console.log("üîê API: Username length:",e.length,"Password length:",t.length);const s=e.trim(),r=t.trim();console.log("üîê API: Trimmed username:",s,"Trimmed password length:",r.length),this.clearToken();try{const f=`${l()}/auth/login`;console.log(`üîê API: Making direct login request to ${f}`),console.log("üîê API: Request body:",{username:s,password:"***"});const d=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s,password:r})});if(console.log("üîê API: Response status:",d.status),!d.ok){const y=await d.text();console.error("‚ùå Login HTTP error:",d.status,y);try{const m=JSON.parse(y);throw new Error(m.detail||"Invalid username or password")}catch{throw new Error("Invalid username or password")}}const c=await d.json();if(console.log("‚úÖ API: Login response received:",{hasToken:!!c.access_token,hasUser:!!c.user,userRole:(o=c.user)==null?void 0:o.role,username:(n=c.user)==null?void 0:n.username}),!c.access_token)throw new Error("No access token received from server");if(!c.user)throw new Error("No user data received from server");return this.setToken(c.access_token),c}catch(a){throw console.error("‚ùå API: Login failed:",a),this.clearToken(),a.message.includes("Invalid username or password")?new Error("Invalid username or password. Please check your credentials."):a.message.includes("Failed to fetch")?new Error("Connection failed. Please check your network connection."):a}}async register(e,t,s,r="student",o=null,n=null,a=[]){const f={username:e,password:t,full_name:s,role:r};r==="student"?(f.department=o,f.level=n):(r==="teacher"||r==="admin")&&(f.departments=a);const d=await this.request("/auth/register",{method:"POST",body:f});return this.setToken(d.access_token),d}logout(){this.clearToken()}async getQuestions(){return this.request("/questions")}async createQuestion(e){return this.request("/questions",{method:"POST",body:e})}async updateQuestion(e,t){return this.request(`/questions/${e}`,{method:"PUT",body:t})}async deleteQuestion(e){return this.request(`/questions/${e}`,{method:"DELETE"})}async clearAllTeacherQuestions(){return this.request("/teacher/questions/clear",{method:"DELETE"})}async deleteQuiz(e){return this.request(`/quizzes/${e}`,{method:"DELETE"})}async getQuizzes(){const t=`${l()}/quizzes?t=${Date.now()}`,s={headers:{"Content-Type":"application/json"}};this._token&&(s.headers.Authorization=`Bearer ${this._token}`);const r=await fetch(t,s);if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}async createQuiz(e){return this.request("/quizzes",{method:"POST",body:e})}async getQuizQuestions(e){try{const s=`${l()}/quizzes/${e}/questions`,r={headers:{"Content-Type":"application/json"}};this._token&&(r.headers.Authorization=`Bearer ${this._token}`);const o=await fetch(s,r),n=await o.json();if(n.quiz_ended||n.quiz_already_attempted)return n;if(!o.ok)throw new Error(`HTTP ${o.status}`);return n}catch(t){throw t}}async submitQuiz(e){return this.request("/quizzes/submit",{method:"POST",body:e})}async activateQuiz(e){return this.request(`/quizzes/${e}/activate`,{method:"PUT"})}async broadcastQuiz(e){console.log("üì° API: Broadcasting quiz",e);const t=await this.request(`/quizzes/${e}/broadcast`,{method:"PUT"});return console.log("üì° API: Broadcast result:",t),t}async exportQuizPDF(e){const t=l(),s=this.token||this._token;if(!s)throw new Error("Authentication required");const r=await fetch(`${t}/quizzes/${e}/export`,{headers:{Authorization:`Bearer ${s}`}});if(!r.ok){const o=await r.text();throw console.error("PDF export failed:",r.status,o),new Error("Export failed")}return r.blob()}async exportQuizExcel(e){const t=l(),s=this.token||this._token;if(!s)throw new Error("Authentication required");const r=await fetch(`${t}/quizzes/${e}/export/excel`,{headers:{Authorization:`Bearer ${s}`}});if(!r.ok){const o=await r.text();throw console.error("Excel export failed:",r.status,o),new Error("Export failed")}return r.blob()}async getLeaderboard(e){return this.request(`/leaderboard/${e}`)}async getQuizResults(e){return this.request(`/results/${e}`)}async getSchedules(){return this.request("/schedules")}async createSchedule(e){return this.request("/schedules",{method:"POST",body:e})}async getAnnouncements(){return this.request("/announcements")}async createAnnouncement(e){return this.request("/announcements",{method:"POST",body:e})}async deactivateAnnouncement(e){return this.request(`/announcements/${e}/deactivate`,{method:"PUT"})}async getLessons(){return this.request("/lessons")}async createLesson(e){console.log("üîß API: Creating lesson with data:",e);try{const s=`${l()}/lessons`;if(P&&!this.token){const n=localStorage.getItem("token");if(n)this.token=n;else throw new Error("Authentication required. Please login again.")}console.log(`üîß API: Making direct lesson creation request to ${s}`);const r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(e)});if(!r.ok){const n=await r.text();throw console.error("‚ùå Lesson creation HTTP error:",r.status,n),r.status===401?new Error("Authentication failed. Please login again."):r.status===403?new Error("Permission denied. Admin access required."):new Error(`Lesson creation failed: ${r.status}`)}const o=await r.json();return console.log("‚úÖ API: Lesson created successfully:",o),o}catch(t){throw console.error("‚ùå API: Lesson creation failed:",t),t}}async deactivateLesson(e){return this.request(`/lessons/${e}/deactivate`,{method:"PUT"})}async getTeachers(){return this.request("/teachers")}async registerTeacher(e,t,s,r,o=!1,n="",a=""){var f,d,c,y;if(console.log("üîß API: Registering teacher with data:",{username:e,fullName:s,departments:r,isClassTeacher:o,classDepartment:n,classLevel:a}),!e||!t||!s)throw new Error("Username, password, and full name are required");if(!r||r.length===0)throw new Error("At least one department must be selected");if(o&&(!n||!a))throw new Error("Class department and level are required for class teachers");try{const T=`${l()}/admin/register-teacher`;if(P&&!this.token){const w=localStorage.getItem("token");if(w)this.token=w;else throw new Error("Admin authentication required. Please login again.")}console.log(`üîß API: Making direct teacher registration request to ${T}`);const h=await fetch(T,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({username:e.trim(),password:t,full_name:s.trim(),departments:r})});if(!h.ok){const w=await h.text();console.error("‚ùå Teacher registration HTTP error:",h.status,w);try{const q=JSON.parse(w);throw new Error(q.detail||q.message||"Registration failed")}catch{throw h.status===400?new Error("Username already exists or invalid data provided"):h.status===401?new Error("Authentication failed. Please login as DOS again."):h.status===403?new Error("DOS access required. Only administrators can register teachers."):new Error(`Registration failed with status ${h.status}`)}}const p=await h.json();return console.log("‚úÖ API: Teacher registration successful:",{teacherId:(f=p.teacher)==null?void 0:f.id,username:(d=p.teacher)==null?void 0:d.username,fullName:(c=p.teacher)==null?void 0:c.full_name,departments:(y=p.teacher)==null?void 0:y.departments}),p}catch(m){throw console.error("‚ùå API: Teacher registration failed:",m),m.message.includes("Failed to fetch")?new Error("Connection failed. Please check your network connection and ensure the backend is running."):m.message.includes("Authentication")?new Error("Authentication failed. Please logout and login again as DOS."):m}}async assignLessonToTeacher(e,t){console.log("üîß API: Assigning lesson to teacher:",{teacherId:e,lessonId:t});try{const r=`${l()}/teacher-lessons`;if(P&&!this.token){const a=localStorage.getItem("token");if(a)this.token=a;else throw new Error("Authentication required. Please login again.")}console.log(`üîß API: Making direct lesson assignment request to ${r}`);const o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({teacher_id:e,lesson_id:t})});if(!o.ok){const a=await o.text();throw console.error("‚ùå Lesson assignment HTTP error:",o.status,a),o.status===401?new Error("Authentication failed. Please login again."):o.status===403?new Error("Permission denied. DOS access required."):o.status===400?new Error("Assignment failed. Teacher may already be assigned to this lesson."):new Error(`Assignment failed: ${o.status}`)}const n=await o.json();return console.log("‚úÖ API: Lesson assignment successful:",n),n}catch(s){throw console.error("‚ùå API: Lesson assignment failed:",s),s}}async getTeacherLessons(e){return this.request(`/teacher-lessons/${e}`)}async removeTeacherLesson(e){console.log("üîß API: Removing teacher lesson assignment:",e);try{const s=`${l()}/teacher-lessons/${e}`;if(P&&!this.token){const n=localStorage.getItem("token");if(n)this.token=n;else throw new Error("Authentication required. Please login again.")}console.log(`üîß API: Making direct lesson removal request to ${s}`);const r=await fetch(s,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`}});if(!r.ok){const n=await r.text();throw console.error("‚ùå Lesson removal HTTP error:",r.status,n),r.status===401?new Error("Authentication failed. Please login again."):r.status===403?new Error("Permission denied. DOS access required."):r.status===404?new Error("Assignment not found."):new Error(`Removal failed: ${r.status}`)}const o=await r.json();return console.log("‚úÖ API: Lesson removal successful:",o),o}catch(t){throw console.error("‚ùå API: Lesson removal failed:",t),t}}async getNotifications(){return this.request("/notifications")}async markNotificationRead(e){return this.request(`/notifications/${e}/read`,{method:"PUT"})}async forwardQuizResults(e){return this.request(`/quiz-results/${e}/forward`,{method:"POST"})}async getMyCourses(){return this.request("/my-courses")}async getStudents(e=null,t=null){let s="/admin/students";const r=new URLSearchParams;return e&&r.append("department",e),t&&r.append("level",t),r.toString()&&(s+="?"+r.toString()),(await this.request(s)).students||[]}async downloadAllResultsExcel(){const e=l(),t=await fetch(`${e}/admin/results/download/excel`,{headers:{Authorization:`Bearer ${this.token}`}});if(!t.ok)throw new Error("Download failed");return t.blob()}async generateStudentCredentialsPDF(e,t){console.log("üîë API: Generating student credentials PDF:",{department:e,level:t});try{const r=`${l()}/admin/generate-student-credentials/${encodeURIComponent(e)}/${encodeURIComponent(t)}`;if(P&&!this.token){const a=localStorage.getItem("token");if(a)this.token=a;else throw new Error("Admin authentication required. Please login again.")}console.log(`üîë API: Making credentials generation request to ${r}`);const o=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${this.token}`}});if(!o.ok){const a=await o.text();throw console.error("‚ùå Credentials generation HTTP error:",o.status,a),o.status===401?new Error("Authentication failed. Please login as DOS again."):o.status===403?new Error("DOS access required. Only administrators can generate credentials."):o.status===404?new Error(`No students found for ${e} - ${t}`):new Error(`Credentials generation failed: ${o.status}`)}const n=await o.blob();return console.log("‚úÖ API: Credentials PDF generated successfully"),n}catch(s){throw console.error("‚ùå API: Credentials generation failed:",s),s}}async downloadAllResultsPDF(){const e=l(),t=await fetch(`${e}/admin/results/download/pdf`,{headers:{Authorization:`Bearer ${this.token}`}});if(!t.ok)throw new Error("Download failed");return t.blob()}async downloadStudentReport(e){let t=this._token;if(t||(t=localStorage.getItem("token"),t&&(this._token=t)),!t)throw new Error("Authentication required. Please login again.");const r=`${l()}/student-report/${e}`;console.log("üì• Downloading student report for quiz:",e);const o=await fetch(r,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok){const n=await o.text();throw console.error("‚ùå Report download failed:",o.status,n),new Error(n||"Report generation failed")}return console.log("‚úÖ Report downloaded successfully"),o.blob()}async assignClassTeacher(e,t,s){return this.request("/admin/assign-class-teacher",{method:"POST",body:{teacher_id:e,department:t,level:s}})}async getClassTeachers(){return this.request("/admin/class-teachers")}async uploadStudents(e){console.log("üì§ API: Uploading students:",e.length);try{const s=`${l()}/teacher/upload-students`;if(P&&!this.token){const n=localStorage.getItem("token");if(n)this.token=n;else throw new Error("Authentication required. Please login again.")}console.log(`üì§ API: Making direct student upload request to ${s}`);const r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({students:e})});if(!r.ok){const n=await r.text();throw console.error("‚ùå Student upload HTTP error:",r.status,n),r.status===401?new Error("Authentication failed. Please login again."):r.status===403?new Error("Permission denied. Admin access required."):new Error(`Upload failed: ${r.status}`)}const o=await r.json();return console.log("‚úÖ API: Student upload successful:",o),o}catch(t){throw console.error("‚ùå API: Student upload failed:",t),t}}async uploadStudentFile(e){console.log("üìÑ API: Processing student file:",e.name);try{const s=`${l()}/teacher/upload-students-file`;if(P&&!this.token){const a=localStorage.getItem("token");if(a)this.token=a;else throw new Error("Authentication required. Please login again.")}const r=new FormData;r.append("file",e),console.log(`üìÑ API: Making file upload request to ${s}`);const o=await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:r});if(!o.ok){const a=await o.text();throw console.error("‚ùå File upload HTTP error:",o.status,a),o.status===401?new Error("Authentication failed. Please login again."):o.status===400?new Error("Invalid file format or content."):new Error(`File processing failed: ${o.status}`)}const n=await o.json();return console.log("‚úÖ API: File processing successful:",n),n}catch(t){throw console.error("‚ùå API: File upload failed:",t),t}}async getMyClasses(){return this.request("/teacher/my-classes")}async clearAllStudents(){console.log("üóëÔ∏è API: Clearing all students");try{const t=`${l()}/admin/clear-all-students`;if(P&&!this.token){const o=localStorage.getItem("token");if(o)this.token=o;else throw new Error("Admin authentication required. Please login again.")}console.log(`üóëÔ∏è API: Making clear students request to ${t}`);const s=await fetch(t,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`}});if(!s.ok){const o=await s.text();throw console.error("‚ùå Clear students HTTP error:",s.status,o),s.status===401?new Error("Authentication failed. Please login as DOS again."):s.status===403?new Error("DOS access required. Only administrators can clear students."):new Error(`Clear operation failed: ${s.status}`)}const r=await s.json();return console.log("‚úÖ API: Students cleared successfully:",r),r}catch(e){throw console.error("‚ùå API: Clear students failed:",e),e}}async downloadQuizStudentsResults(e){const t=l(),s=await fetch(`${t}/quizzes/${e}/export`,{headers:{Authorization:`Bearer ${this.token}`}});if(!s.ok)throw new Error("Download failed");return s.blob()}async testAuth(){try{const e=await this.request("/auth/test");return this.connectionTested=!0,e}catch(e){throw this.connectionTested=!1,e}}async testConnection(){try{const e=l();return(await fetch(`${e}/health`,{method:"GET"})).ok}catch{return!1}}isConnected(){return this.connectionTested&&!this.isOffline}get API_BASE(){return l()}get baseURL(){return l()}getOfflineStatus(){return this.isOffline||!navigator.onLine}get token(){return this._token||(this._token=localStorage.getItem("token")),this._token}set token(e){this._token=e}async resetTeacherPassword(e){return this.request("/reset-teacher-password",{method:"POST",body:{username:e}})}async resetTeacherPasswordById(e,t){return this.request(`/admin/reset-teacher-password/${e}?new_password=${encodeURIComponent(t)}`,{method:"POST"})}async updateTeacher(e,t){return this.request(`/admin/teacher/${e}`,{method:"PUT",body:t})}async getStudentProgress(){return this.request("/student/progress")}async downloadDepartmentReport(e){const t=new URLSearchParams(e).toString(),s=l(),r=await fetch(`${s}/admin/reports/department?${t}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!r.ok)throw new Error("Report generation failed");const o=await r.blob(),n=window.URL.createObjectURL(o),a=document.createElement("a");return a.href=n,a.download=`${e.department}_${e.level}_${e.reportType}_report.pdf`,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(n),o}async downloadDepartmentReportExcel(e){const t=new URLSearchParams(e).toString(),s=l(),r=await fetch(`${s}/admin/reports/department/excel?${t}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!r.ok)throw new Error("Excel report generation failed");const o=await r.blob(),n=window.URL.createObjectURL(o),a=document.createElement("a");return a.href=n,a.download=`${e.department}_${e.level}_${e.reportType}_report.xlsx`,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(n),o}async getPendingReviews(){return this.request("/teacher/pending-reviews")}async getAttemptForReview(e){return this.request(`/teacher/review/${e}`)}async submitReview(e,t){return this.request(`/teacher/review/${e}/grade`,{method:"POST",body:{grades:t}})}async releaseQuizResults(e){return this.request(`/teacher/quiz/${e}/release-results`,{method:"POST"})}async getReviewStatus(e){return this.request(`/teacher/quiz/${e}/review-status`)}async reportCheating(e){return this.request("/report-cheating",{method:"POST",body:e})}}const C=new v;export{_ as a,L as b,E as c,C as d,g as s,x as u};
